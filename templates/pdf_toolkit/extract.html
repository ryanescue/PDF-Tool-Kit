{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Document Extractor</title>
    <link rel="stylesheet" href="{% static 'pdf_toolkit/extract.css' %}">
</head>
<body>
    {% include 'includes/nav.html' %}
    <main class="extract-page">
        <section class="extract-panel">
            <!-- Primary extractor workflow card -->
            <div class="extract-header">
                <h1>Extract text from PDFs</h1>
                <p>Upload by dragging a PDF into the drop zone or using the picker. Choose an OCR method and optionally limit the page range.</p>
            </div>

            {% if error %}
                <p class="flash flash--error">{{ error }}</p>
            {% endif %}
            {% if csv_error %}
                <p class="flash flash--error">{{ csv_error }}</p>
            {% endif %}
            {% if xlsx_error %}
                <p class="flash flash--error">{{ xlsx_error }}</p>
            {% endif %}
            {% if text and not error %}
                <p class="flash flash--success">Extraction complete. Copy or download the text below.</p>
            {% endif %}

            <div class="extract-layout">
                <!-- Left column: upload + controls -->
                <form class="extract-form" method="post" enctype="multipart/form-data" id="extract-form">
                    {% csrf_token %}
                    <div class="file-picker-wrapper">
                        <button type="button" class="file-picker" id="extract-select-button">Select PDF</button>
                        <p class="helper-text helper-text--file" id="extract-file-label">No file selected yet.</p>
                    </div>
                    <input type="file" id="extract-file-input" name="pdf" accept="application/pdf" required hidden>

                    <div class="form-grid">
                        <label class="method-field">
                            <span class="method-label__text">
                                Method
                                <button type="button"
                                        class="info-bubble"
                                        id="method-info-trigger"
                                        aria-expanded="false"
                                        aria-controls="method-info-popover">
                                    <span class="visually-hidden">Which method should I use?</span>
                                    i
                                </button>
                            </span>
                            <select name="method">
                                <option value="auto" {% if selected_method == "auto" %}selected{% endif %}>Auto</option>
                                <option value="pypdf" {% if selected_method == "pypdf" %}selected{% endif %}>PyPDF</option>
                                <option value="tesseract" {% if selected_method == "tesseract" %}selected{% endif %}>Tesseract</option>
                                <option value="easyocr" {% if selected_method == "easyocr" %}selected{% endif %}>EasyOCR</option>
                            </select>
                            <div class="method-info-popover" id="method-info-popover" role="dialog" aria-labelledby="method-info-title">
                                <div class="method-info-popover__header">
                                    <h3 id="method-info-title">Which method should I use?</h3>
                                    <button type="button" class="method-info-close" id="method-info-close" aria-label="Close method tips">&times;</button>
                                </div>
                                <p class="method-helper__lede">Pick the option that matches the type of PDF you uploaded.</p>
                                <ul class="method-cards">
                                    <li class="method-card">
                                        <span class="method-card__title">Auto</span>
                                        <p class="method-card__text">Best default. Tries PyPDF first and falls back to OCR if the PDF does not expose selectable text.</p>
                                    </li>
                                    <li class="method-card">
                                        <span class="method-card__title">PyPDF</span>
                                        <p class="method-card__text">Fastest option for digitally-created PDFs (exports from Google Docs, Word, etc.). Uses the embedded text layer.</p>
                                    </li>
                                    <li class="method-card">
                                        <span class="method-card__title">Tesseract OCR</span>
                                        <p class="method-card__text">Use for scanned documents. Converts each page to an image and runs Tesseract for English characters.</p>
                                    </li>
                                    <li class="method-card">
                                        <span class="method-card__title">EasyOCR</span>
                                        <p class="method-card__text">Similar to Tesseract but better for mixed or stylized fonts. Supports multiple languages if your PDFs include them.</p>
                                    </li>
                                </ul>
                            </div>
                        </label>

                        <label>
                            Page range (optional)
                            <input type="text" name="pages" value="{{ pages }}" placeholder="All pages or e.g. 1-3,5">
                            <small>Use commas for multiple ranges. Leave blank for every page.</small>
                        </label>
                    </div>

                    <label class="normalize-toggle">
                        <input type="checkbox" name="normalize" value="1" {% if normalize %}checked{% endif %}>
                        Normalize whitespace
                    </label>
                    <label class="normalize-toggle">
                        <input type="checkbox" name="scanned_hint" value="1" {% if scanned_hint %}checked{% endif %}>
                        This is a scanned document (improve OCR)
                    </label>
                    <label class="normalize-toggle">
                        <input type="checkbox" name="deskew_hint" value="1" {% if deskew_hint %}checked{% endif %}>
                        Deskew crooked scans (experimental)
                    </label>
                    <label class="normalize-toggle">
                        <input type="checkbox" name="export_csv" value="1" {% if export_csv %}checked{% endif %}>
                        Detect tables and export CSV (experimental)
                    </label>
                    <label class="normalize-toggle">
                        <input type="checkbox" name="export_xlsx" value="1" {% if export_xlsx %}checked{% endif %}>
                        Detect tables and export Excel (experimental)
                    </label>

                    <button type="submit" class="primary-button">Extract</button>
                </form>
            </div>
            <div class="progress-overlay" id="extract-progress" aria-hidden="true">
                <div class="progress-dialog" role="status" aria-live="assertive">
                    <p>Working on your document…</p>
                    <div class="progress-bar">
                        <span class="progress-bar__fill"></span>
                    </div>
                </div>
            </div>

            {% if csv_preview %}
                <section class="extract-output">
                    <div class="extract-output__header">
                        <h2>Detected table</h2>
                        <a class="ghost-button" href="{% url 'extract_download' csv_preview.artifact_id %}">Download CSV</a>
                    </div>
                    <div class="table-preview">
                        <table>
                            <thead>
                                <tr>
                                    {% for header in csv_preview.headers %}
                                        <th>{{ header }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in csv_preview.rows %}
                                    <tr>
                                        {% for cell in row %}
                                            <td>{{ cell }}</td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <p class="helper-text">Showing first {{ csv_preview.count }} row(s). Full CSV download includes {{ csv_preview.total }} rows.</p>
                    </div>
                </section>
            {% endif %}
            {% if xlsx_artifact_id %}
                <section class="extract-output">
                    <div class="extract-output__header">
                        <h2>Excel export</h2>
                        <a class="ghost-button" href="{% url 'extract_download' xlsx_artifact_id %}">Download XLSX</a>
                    </div>
                </section>
            {% endif %}

            {% if text %}
                <section class="extract-output">
                    <div class="extract-output__header">
                        <h2>Extracted text</h2>
                        <div class="extract-output__actions">
                            <button type="button" id="copy-current" class="ghost-button">Copy all</button>
                            {% if text_artifact_id %}
                                <a class="ghost-button" href="{% url 'extract_download' text_artifact_id %}">Download TXT</a>
                            {% endif %}
                        </div>
                    </div>
                    <textarea class="result" id="current-result" readonly>{{ text }}</textarea>
                </section>
            {% endif %}
        </section>

        <!-- Activity/history sidebar -->
        <section class="history-panel">
            <div class="history-header">
                <h2>Recent extractions</h2>
                <p>Preview, copy, or download past extractions. Apply the same settings with one click.</p>
            </div>
            {% if history %}
                <ul class="history-list">
                    {% for item in history %}
                        <li class="history-item">
                            <div class="history-info">
                                <p class="history-title">{{ item.title }}</p>
                                <p class="history-meta">Method {{ item.method|title }} &middot; {{ item.page_range }} &middot; {{ item.created }}</p>
                                {% if item.snippet %}
                                    <p class="history-snippet">{{ item.snippet }}{% if item.snippet|length == 600 %}…{% endif %}</p>
                                {% endif %}
                            </div>
                            <div class="history-actions">
                                <button type="button"
                                        class="ghost-button history-preview"
                                        data-artifact="{{ item.artifact_id }}"
                                        data-title="{{ item.title }}"
                                        data-download="{% url 'extract_download' item.artifact_id %}">
                                    Preview
                                </button>
                                <a class="ghost-button" href="{% url 'extract_download' item.artifact_id %}">Download TXT</a>
                                {% if item.csv_artifact_id %}
                                    <a class="ghost-button" href="{% url 'extract_download' item.csv_artifact_id %}">Download CSV</a>
                                {% endif %}
                                {% if item.xlsx_artifact_id %}
                                    <a class="ghost-button" href="{% url 'extract_download' item.xlsx_artifact_id %}">Download XLSX</a>
                                {% endif %}
                                <button type="button"
                                        class="ghost-button history-apply"
                                        data-method="{{ item.method }}"
                                        data-pages="{{ item.page_range }}">
                                    Use settings
                                </button>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="empty-state">No extractions yet. Run your first extraction to build a history.</p>
            {% endif %}
        </section>
    </main>

    <!--previewing the extracted text -->
        <div class="preview-modal" id="preview-modal">
            <div class="preview-modal__dialog">
                <div class="preview-modal__header">
                    <h3 id="preview-title">Preview</h3>
                    <button type="button" id="preview-close">&times;</button>
                </div>
                <textarea id="preview-text" readonly></textarea>
                <div class="preview-modal__actions">
                    <button type="button" id="preview-copy" class="primary-button">Copy</button>
                    <a id="preview-download" class="ghost-button" href="#" download>Download</a>
                </div>
            </div>
        </div>

    <script>
    (function () {
        const fileInput = document.getElementById("extract-file-input");
        const fileLabel = document.getElementById("extract-file-label");
        const selectButton = document.getElementById("extract-select-button");

        // Mirror Splitter/Merger picker: open one dialog and keep status text in sync
        function updateLabel(text) {
            if (!fileLabel) return;
            fileLabel.textContent = text;
            if (text && text !== "No file selected yet.") {
                fileLabel.classList.add("helper-text--file--active");
            } else {
                fileLabel.classList.remove("helper-text--file--active");
            }
        }

        function openPicker(event) {
            event?.preventDefault();
            fileInput?.click();
        }

        fileInput?.addEventListener("change", (event) => {
            const files = event.target.files;
            if (!files || !files.length) {
                updateLabel("No file selected yet.");
                return;
            }
            updateLabel(`Selected: ${files[0].name}`);
        });
        selectButton?.addEventListener("click", openPicker);
    })();

    (function () {
        const previewButtons = document.querySelectorAll(".history-preview");
        const modal = document.getElementById("preview-modal");
        const modalTitle = document.getElementById("preview-title");
        const modalText = document.getElementById("preview-text");
        const modalDownload = document.getElementById("preview-download");
        const closeBtn = document.getElementById("preview-close");
        const copyBtn = document.getElementById("preview-copy");

        function openModal() {
            modal?.classList.add("is-visible");
            document.body.classList.add("no-scroll");
        }

        function closeModal() {
            modal?.classList.remove("is-visible");
            document.body.classList.remove("no-scroll");
        }

        previewButtons.forEach((button) => {
            button.addEventListener("click", async () => {
                const artifactId = button.dataset.artifact;
                if (!artifactId) return;
                modalTitle.textContent = button.dataset.title || "Preview";
                modalDownload.href = button.dataset.download || "#";
                modalText.value = "Loading…";
                openModal();
                try {
                    const response = await fetch(`/extract/${artifactId}/preview/`, { headers: { "X-Requested-With": "XMLHttpRequest" }});
                    const data = await response.json();
                    modalText.value = data.text || "";
                } catch (error) {
                    modalText.value = "Unable to load preview.";
                }
            });
        });

        closeBtn?.addEventListener("click", closeModal);
        modal?.addEventListener("click", (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });
        copyBtn?.addEventListener("click", async () => {
            try {
                await navigator.clipboard.writeText(modalText.value);
            } catch (_) {}
        });

        const currentCopy = document.getElementById("copy-current");
        const currentResult = document.getElementById("current-result");
        // Quick copy for the most recent extraction result shown on the page
        currentCopy?.addEventListener("click", async () => {
            if (!currentResult) return;
            try {
                await navigator.clipboard.writeText(currentResult.value);
            } catch (_) {}
        });

        const applyButtons = document.querySelectorAll(".history-apply");
        const methodSelect = document.querySelector('select[name="method"]');
        const pageInput = document.querySelector('input[name="pages"]');
        // Restore historical settings so users can re-run an extraction quickly
        applyButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const method = button.dataset.method;
                const pages = button.dataset.pages;
                if (method && methodSelect) {
                    methodSelect.value = method;
                }
                if (pages && pageInput) {
                    pageInput.value = pages === "All pages" ? "" : pages;
                }
                window.scrollTo({ top: 0, behavior: "smooth" });
            });
        });
    })();

    (function () {
        const trigger = document.getElementById("method-info-trigger");
        const popover = document.getElementById("method-info-popover");
        const closeBtn = document.getElementById("method-info-close");

        if (!trigger || !popover) return;

        function openInfo() {
            popover.classList.add("is-visible");
            trigger.setAttribute("aria-expanded", "true");
        }

        function closeInfo() {
            popover.classList.remove("is-visible");
            trigger.setAttribute("aria-expanded", "false");
        }

        trigger.addEventListener("click", (event) => {
            event.stopPropagation();
            if (popover.classList.contains("is-visible")) {
                closeInfo();
            } else {
                openInfo();
            }
        });

        closeBtn?.addEventListener("click", (event) => {
            event.stopPropagation();
            closeInfo();
        });

        document.addEventListener("click", (event) => {
            if (!popover.classList.contains("is-visible")) {
                return;
            }
            if (!popover.contains(event.target) && event.target !== trigger) {
                closeInfo();
            }
        });

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape" && popover.classList.contains("is-visible")) {
                closeInfo();
            }
        });
    })();

    (function () {
        const form = document.getElementById("extract-form");
        const overlay = document.getElementById("extract-progress");
        const submitButton = form?.querySelector("button[type='submit']");
        if (!form || !overlay) return;

        form.addEventListener("submit", () => {
            overlay.classList.add("is-visible");
            overlay.setAttribute("aria-hidden", "false");
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = "Processing…";
            }
        });
    })();
    </script>
</body>
</html>
