{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Merge &amp; Create PDF</title>
    <link rel="stylesheet" href="{% static 'pdf_toolkit/merge.css' %}">
</head>
<body>
    {% include 'includes/nav.html' %}
    <main class="merge-page">
        <section class="merge-builder">
            <h1>Merge / Create PDF</h1>
            <p class="lede">
                Upload JPG, PNG, DOC/DOCX, TXT, or existing PDF files, arrange them in the exact order you need,
                and we will combine everything into a single downloadable PDF.
            </p>

            {% if error %}
                <p class="flash flash--error">{{ error }}</p>
            {% endif %}
            {% if success %}
                <p class="flash flash--success">{{ success }}</p>
            {% endif %}

            <form method="post" enctype="multipart/form-data" class="merge-form" id="merge-form">
                {% csrf_token %}
                <div class="file-select">
                    <label class="file-select__control">
                        <span>Select files</span>
                        <input type="file" id="file-input" name="files" accept="{{ allowed_types }}" multiple>
                    </label>
                    <p class="helper-text">Hold Ctrl/Cmd or Shift in the picker to add several at once, or reopen it to add more.</p>
                    <p class="helper-text">Supported formats: {{ allowed_types_display }}</p>
                </div>

                <div class="selected-files-box">
                    <div class="selected-files-header">
                        <h3>Selected files</h3>
                        <button type="button" id="clear-files" class="ghost-button ghost-button--compact" disabled>Clear all</button>
                    </div>
                    <p id="selected-empty" class="empty-state-sm">No files selected yet.</p>
                    <ul class="selected-list" id="selected-files"></ul>
                </div>

                <p class="flash flash--error" id="client-error" hidden>Please select at least one file before merging.</p>

                <label class="output-label">
                    Output PDF name
                    <input type="text" name="output_name" value="{{ output_name }}" required>
                </label>

                <button type="submit" class="primary-button">Merge files into PDF</button>
            </form>
        </section>

        <section class="merge-history">
            <div class="history-header">
                <h2>Files merged / converted</h2>
                <p>Download the latest results or clear them by starting a new merge.</p>
            </div>
            {% if history %}
                <ul class="history-list">
                    {% for item in history %}
                        <li class="history-item">
                            <div class="history-item__info">
                                <p class="history-item__name">{{ item.name }}</p>
                                <p class="history-item__meta">{{ item.total }} file{% if item.total != 1 %}s{% endif %} &middot; {{ item.created }}</p>
                            </div>
                            <a class="download-link" href="{% url 'merge_download' item.artifact_id %}" aria-label="Download {{ item.name }}">
                                &#8681;
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="empty-state">You haven't merged anything yet. Upload files on the left to get started.</p>
            {% endif %}
        </section>
    </main>

    <div id="merge-progress" class="merge-progress" hidden>
        <div class="merge-progress__info">
            <span id="merge-progress-text">Preparing your PDF...</span>
            <span id="merge-progress-percent">0%</span>
        </div>
        <div class="merge-progress__track">
            <div id="merge-progress-fill" class="merge-progress__fill"></div>
        </div>
    </div>

    <script>
    (function () {
        const fileInput = document.getElementById("file-input");
        const selectedList = document.getElementById("selected-files");
        const emptyState = document.getElementById("selected-empty");
        const clearButton = document.getElementById("clear-files");
        const mergeForm = document.getElementById("merge-form");
        const clientError = document.getElementById("client-error");
        const outputField = document.querySelector('input[name="output_name"]');
        const progressBar = document.getElementById("merge-progress");
        const progressText = document.getElementById("merge-progress-text");
        const progressPercent = document.getElementById("merge-progress-percent");
        const progressFill = document.getElementById("merge-progress-fill");

        let selectedFiles = [];
        let dragIndex = null;
        let progressTimer = null;
        let progressValue = 0;

        function renderSelectedFiles() {
            selectedList.innerHTML = "";
            if (!selectedFiles.length) {
                emptyState.hidden = false;
                clearButton.disabled = true;
                return;
            }

            emptyState.hidden = true;
            clearButton.disabled = false;

            selectedFiles.forEach((item, index) => {
                const li = document.createElement("li");
                li.className = "selected-item";
                li.dataset.index = String(index);
                li.setAttribute("draggable", "true");
                li.innerHTML = `
                    <div class="selected-item__name">
                        <strong>${index + 1}.</strong>
                        <span title="${item.file.name}">${item.file.name}</span>
                    </div>
                    <div class="selected-item__controls">
                        <button type="button" data-action="up" title="Move up">&#8593;</button>
                        <button type="button" data-action="down" title="Move down">&#8595;</button>
                        <button type="button" data-action="remove" title="Remove">&times;</button>
                    </div>
                `;
                selectedList.appendChild(li);
            });
        }

        function handleSelection(event) {
            const files = Array.from(event.target.files || []);
            if (!files.length) {
                return;
            }
            files.forEach((file) => selectedFiles.push({ file }));
            fileInput.value = "";
            clientError.hidden = true;
            renderSelectedFiles();
        }

        function handleListClick(event) {
            const button = event.target.closest("button[data-action]");
            if (!button) {
                return;
            }
            const action = button.dataset.action;
            const li = button.closest(".selected-item");
            if (!li) {
                return;
            }
            const index = Number(li.dataset.index);
            if (Number.isNaN(index)) {
                return;
            }

            if (action === "remove") {
                selectedFiles.splice(index, 1);
            } else if (action === "up" && index > 0) {
                [selectedFiles[index - 1], selectedFiles[index]] = [selectedFiles[index], selectedFiles[index - 1]];
            } else if (action === "down" && index < selectedFiles.length - 1) {
                [selectedFiles[index + 1], selectedFiles[index]] = [selectedFiles[index], selectedFiles[index + 1]];
            }
            renderSelectedFiles();
        }

        function handleClear() {
            selectedFiles = [];
            clientError.hidden = true;
            renderSelectedFiles();
        }

        function clearDropHighlights() {
            selectedList
                ?.querySelectorAll(".is-drop-target")
                .forEach((el) => {
                    el.classList.remove("is-drop-target", "is-drop-before", "is-drop-after");
                    delete el.dataset.dropPosition;
                });
        }

        function handleDragStart(event) {
            const li = event.target.closest(".selected-item");
            if (!li) {
                return;
            }
            const index = Number(li.dataset.index);
            if (Number.isNaN(index)) {
                return;
            }
            dragIndex = index;
            event.dataTransfer.effectAllowed = "move";
            event.dataTransfer.setData("text/plain", "");
            li.classList.add("is-dragging");
        }

        function handleDragOver(event) {
            if (dragIndex === null) {
                return;
            }
            const li = event.target.closest(".selected-item");
            if (!li) {
                return;
            }
            event.preventDefault();
            const targetIndex = Number(li.dataset.index);
            if (Number.isNaN(targetIndex) || targetIndex === dragIndex) {
                clearDropHighlights();
                return;
            }
            const rect = li.getBoundingClientRect();
            const isBefore = event.clientY < rect.top + rect.height / 2;
            clearDropHighlights();
            li.classList.add("is-drop-target");
            li.classList.toggle("is-drop-before", isBefore);
            li.classList.toggle("is-drop-after", !isBefore);
            li.dataset.dropPosition = isBefore ? "before" : "after";
        }

        function handleDrop(event) {
            if (dragIndex === null) {
                return;
            }
            const li = event.target.closest(".selected-item");
            if (!li) {
                return;
            }
            event.preventDefault();
            const targetIndexRaw = Number(li.dataset.index);
            if (Number.isNaN(targetIndexRaw) || targetIndexRaw === dragIndex) {
                clearDropHighlights();
                selectedList.querySelectorAll(".is-dragging").forEach((el) => el.classList.remove("is-dragging"));
                dragIndex = null;
                return;
            }

            const dropPosition = li.dataset.dropPosition || "after";
            let targetIndex = targetIndexRaw;
            const [moved] = selectedFiles.splice(dragIndex, 1);
            if (dragIndex < targetIndex) {
                targetIndex -= 1;
            }
            let insertIndex = dropPosition === "after" ? targetIndex + 1 : targetIndex;
            if (insertIndex < 0) {
                insertIndex = 0;
            }
            if (insertIndex > selectedFiles.length) {
                insertIndex = selectedFiles.length;
            }
            selectedFiles.splice(insertIndex, 0, moved);
            dragIndex = null;
            clearDropHighlights();
            selectedList.querySelectorAll(".is-dragging").forEach((el) => el.classList.remove("is-dragging"));
            renderSelectedFiles();
        }

        function handleDragEnd(event) {
            const li = event.target.closest(".selected-item");
            if (li) {
                li.classList.remove("is-dragging");
            }
            dragIndex = null;
            clearDropHighlights();
        }

        function handleSubmit(event) {
            if (!selectedFiles.length) {
                event.preventDefault();
                clientError.hidden = false;
                return;
            }
            const transfer = new DataTransfer();
            selectedFiles.forEach(({ file }) => transfer.items.add(file));
            fileInput.files = transfer.files;
            clientError.hidden = true;
            const label = ((outputField?.value || "").trim()) || "PDF bundle";
            startProgress(label);
        }

        function startProgress(label) {
            stopProgress();
            progressValue = 0;
            progressText.textContent = `Your ${label} is merging`;
            updateProgress(0);
            progressBar.hidden = false;
            progressTimer = setInterval(() => {
                if (progressValue >= 97) {
                    return;
                }
                const increment = Math.random() * 10 + 2;
                progressValue = Math.min(progressValue + increment, 97);
                updateProgress(progressValue);
            }, 400);
        }

        function updateProgress(value) {
            const percent = Math.round(value);
            progressPercent.textContent = `${percent}%`;
            progressFill.style.width = `${percent}%`;
        }

        function stopProgress() {
            if (progressTimer) {
                clearInterval(progressTimer);
                progressTimer = null;
            }
            progressBar.hidden = true;
        }

        fileInput?.addEventListener("change", handleSelection);
        selectedList?.addEventListener("click", handleListClick);
        selectedList?.addEventListener("dragstart", handleDragStart);
        selectedList?.addEventListener("dragover", handleDragOver);
        selectedList?.addEventListener("drop", handleDrop);
        selectedList?.addEventListener("dragend", handleDragEnd);
        clearButton?.addEventListener("click", handleClear);
        mergeForm?.addEventListener("submit", handleSubmit);
        window.addEventListener("beforeunload", stopProgress);

        renderSelectedFiles();
    })();
    </script>
</body>
</html>
